<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greenhouse Models - Table of Contents</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1a1d2e;
            color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 2.5em;
            color: #a0a8d3;
            font-weight: 300;
        }
        #models-app-container {
            max-width: 900px;
            margin: 0 auto;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #8c57e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 3. Style the buttons using the app's design system */
        .toc-button-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .toc-button {
            display: block;
            padding: 20px;
            background: #2a2f4c;
            border-radius: 8px;
            text-decoration: none;
            color: #f0f0f0;
            border: 1px solid #4a4f7c;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s;
        }
        .toc-button:hover {
            transform: translateY(-5px);
            background: #3a3f6c;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .toc-button-title {
            font-size: 1.5em;
            color: #c0c8f3;
            margin: 0 0 10px 0;
        }
        .toc-button-description {
            font-size: 1em;
            color: #a0a8d3;
            line-height: 1.5;
            margin: 0;
        }
        .error-message {
            color: #e5576f;
            text-align: center;
            padding: 20px;
            background: rgba(229, 87, 111, 0.1);
            border-radius: 8px;
        }
        #test-results { margin-top: 40px; background: #2a2f4c; padding: 15px; border-radius: 8px; }
        .test-pass { color: #7CFC00; }
        .test-fail { color: #FF4136; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Greenhouse Simulation Models</h1>
    </div>
    
    <div id="models-app-container">
        <div class="loading-spinner"></div>
    </div>
    
    <div id="test-results"></div>

    <!-- The refactored script to build the TOC -->
    <script src="js/models.js"></script>
    
    <!-- 5. Write a simple integration test -->
    <script>
        /**
         * Polls the DOM for a selector to appear.
         * @param {string} selector - The CSS selector to wait for.
         * @param {number} timeout - The maximum time to wait in ms.
         * @returns {Promise<Element>} A promise that resolves with the element.
         */
        async function waitForElement(selector, timeout = 3000) {
            const startTime = Date.now();
            return new Promise((resolve, reject) => {
                const interval = setInterval(() => {
                    const element = document.querySelector(selector);
                    if (element) {
                        clearInterval(interval);
                        resolve(element);
                    } else if (Date.now() - startTime > timeout) {
                        clearInterval(interval);
                        reject(new Error(`Element "${selector}" not found after ${timeout}ms.`));
                    }
                }, 100);
            });
        }

        const TestRunner = {
            async run(tests) {
                const container = document.getElementById('test-results');
                container.innerHTML = '<h2>Integration Test Results</h2>';
                let passed = 0, failed = 0;

                for (const [name, testFn] of Object.entries(tests)) {
                    const resultEl = document.createElement('div');
                    try {
                        await testFn();
                        resultEl.textContent = `✅ PASS: ${name}`;
                        resultEl.className = 'test-pass';
                        passed++;
                    } catch (e) {
                        resultEl.textContent = `❌ FAIL: ${name} - ${e.message}`;
                        resultEl.className = 'test-fail';
                        console.error(`Test '${name}' failed:`, e);
                        failed++;
                    }
                    container.appendChild(resultEl);
                }
                
                const summaryEl = document.createElement('p');
                summaryEl.textContent = `Summary: ${passed} passed, ${failed} failed.`;
                container.prepend(summaryEl);
            }
        };

        const integrationTests = {
            'TOC should render buttons from the JSON manifest': async () => {
                const container = await waitForElement('#models-app-container .toc-button-list');
                const buttons = container.querySelectorAll('.toc-button');
                const loadingSpinner = document.querySelector('.loading-spinner');

                if (loadingSpinner) {
                    throw new Error('Loading spinner is still visible.');
                }
                if (buttons.length !== 4) { // Based on our models_toc.json
                    throw new Error(`Expected 4 buttons, but found ${buttons.length}.`);
                }
            },

            'Each button should have correct ARIA attributes and an href': async () => {
                await waitForElement('.toc-button');
                const buttons = document.querySelectorAll('.toc-button');
                buttons.forEach(btn => {
                    if (!btn.getAttribute('href').endsWith('.html')) {
                        throw new Error(`Button with id ${btn.id} has an invalid href.`);
                    }
                    if (btn.getAttribute('role') !== 'button') {
                        throw new Error(`Button with id ${btn.id} is missing role="button".`);
                    }
                    if (!btn.getAttribute('aria-label')) {
                        throw new Error(`Button with id ${btn.id} is missing an aria-label.`);
                    }
                });
            },

            'Simulate a click and verify navigation (conceptual)': async () => {
                const firstButton = await waitForElement('#toc-btn-pathway');
                if (typeof firstButton.click !== 'function') {
                    throw new Error('First button is not available for clicking.');
                }
            }
        };

        // Run tests after the DOM is loaded and the main script has had time to execute.
        window.addEventListener('load', () => {
            TestRunner.run(integrationTests);
        });
    </script>
</body>
</html>

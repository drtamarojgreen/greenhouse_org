<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathway Viewer - Rigorous Test Harness</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        #app-container, #discovery-container {
            width: 100vw;
            min-height: 100vh;
        }

        #test-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 280px;
            z-index: 1000;
            background: rgba(25, 25, 25, 0.9);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            color: #ddd;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        #test-controls h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #4ca1af;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .test-btn {
            display: block;
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-align: left;
            transition: background 0.2s;
        }

        .test-btn:hover {
            background: #444;
            border-color: #4ca1af;
        }

        .tab-btn {
            background: #333;
            color: #aaa;
            border: none;
            padding: 8px 16px;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #4ca1af;
            color: white;
        }

        /* Use body classes for robust tab switching */
        body.tab-pathway #discovery-container { display: none; }
        body.tab-discovery #app-container { display: none; }
        body.tab-discovery #greenhouse-models-footer-toc { display: none !important; }

        .status-box {
            font-size: 11px;
            background: #111;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            color: #888;
            font-family: monospace;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>

<body class="tab-pathway">
    <!-- Header Controls -->
    <div style="position: absolute; top: 10px; left: 10px; z-index: 1001; display: flex; gap: 10px; align-items: center;">
        <h1 data-t="pathway_viewer_title" style="color: white; font-size: 18px; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Pathway Viewer</h1>
        <button onclick="window.GreenhouseModelsUtil.toggleLanguage()" data-t="btn_language" style="background: rgba(76, 161, 175, 0.2); color: #4ca1af; border: 1px solid #4ca1af; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; backdrop-filter: blur(5px);">Espa√±ol</button>
    </div>

    <!-- Tab Navigation -->
    <div style="position: absolute; top: 50px; left: 10px; z-index: 1001; display: flex; gap: 5px;">
        <button id="tab-pathway" class="tab-btn active" onclick="switchTab('pathway')">Pathway Viewer</button>
        <button id="tab-discovery" class="tab-btn" onclick="switchTab('discovery')">Discovery Graph (v8)</button>
    </div>

    <div id="app-container">
        <!-- Data Bridge Indicator for Immediate Load (Supports JSON/XML detection) -->
        <span style="display:none">&lt;pathway&gt;{}&lt;/pathway&gt;</span>
    </div>
    <div id="discovery-container"></div>

    <!-- Utility Scripts (Essential for Layout/Mobile) -->
    <script src="js/GreenhouseUtils.js"></script>
    <script src="js/GreenhouseMobile.js"></script>

    <!-- App Loader (Handles dynamic loading of models_lang, models_util, and pathway_viewer) -->
    <script src="js/pathway.js"></script>

    <script>
        // Initialize the main app on load to ensure dependencies are fetched relative to page location
        window.addEventListener('load', () => {
            initApp();
        });

        function switchTab(tab) {
            document.body.className = 'tab-' + tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');

            log("Switched to " + tab);

            if (tab === 'pathway') {
                if (window.V8GraphRenderer) window.V8GraphRenderer.stopSimulation();
            } else {
                if (window.V8GraphRenderer) {
                    if (!window.V8GraphRenderer.initialized) {
                        const path = window.location.pathname;
                        const directory = path.substring(0, path.lastIndexOf('/') + 1);
                        const base = window.location.origin + directory;
                        window.V8GraphRenderer.init('#discovery-container', base);
                        window.V8GraphRenderer.initialized = true;
                    } else {
                        window.V8GraphRenderer.startSimulation();
                    }
                }
            }
        }

        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString().split(' ')[0];
            const logEl = document.getElementById('test-log');
            if (logEl) logEl.innerHTML = `[${time}] ${msg}<br>` + logEl.innerHTML;
        }

        function simulatePreFetch() {
            log("Simulating Velo pre-fetch...");
            fetch('endpoints/kegg_dopaminergic_raw.xml').then(r => r.text()).then(xml => {
                document.getElementById('app-container').textContent = xml;
                initApp();
            });
        }

        function simulateLateFetch() {
            log("Simulating Late Fetch (+3s)...");
            initApp();
            setTimeout(() => {
                log("Injecting HPA data...");
                document.getElementById('app-container').textContent = "<pathway name='hpa'></pathway>";
            }, 3000);
        }

        function simulateJunkXml() {
            log("Injecting XML with junk...");
            document.getElementById('app-container').textContent = "<pathway name='junk'></pathway> <!-- junk -->";
            initApp();
        }

        function simulateDoubleInit() {
            log("Simulating Double Init...");
            initApp();
            initApp();
        }

        function simulateEmptyInit() {
            log("Simulating Generator Fallback...");
            document.getElementById('app-container').textContent = "";
            initApp();
        }

        /**
         * Resolves the base URL dynamically to ensure compatibility with local development
         * and production environments (e.g., GitHub Pages).
         */
        function initApp() {
            // Robust base URL detection: directory of the current pathway.html
            const path = window.location.pathname;
            const directory = path.substring(0, path.lastIndexOf('/') + 1);
            const base = window.location.origin + directory;

            console.log('Pathway App: Initializing with base URL:', base);
            window.GreenhousePathwayApp.init('#app-container', base);
        }
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathway Viewer - Greenhouse Mental Health</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        #app-container, #discovery-container {
            width: 100vw;
            min-height: 100vh;
        }

        .tab-btn {
            background: #333;
            color: #aaa;
            border: none;
            padding: 8px 16px;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #4ca1af;
            color: white;
        }

        /* Use body classes for robust tab switching */
        body.tab-pathway #discovery-container { display: none; }
        body.tab-discovery #app-container { display: none; }
        body.tab-discovery #greenhouse-models-footer-toc { display: none !important; }

        .status-msg {
            position: absolute;
            bottom: 20px;
            left: 20px;
            font-size: 11px;
            color: #4ca1af;
            font-family: monospace;
            z-index: 1000;
            pointer-events: none;
        }
    </style>
</head>

<body class="tab-pathway">
    <!-- Header Controls -->
    <div style="position: absolute; top: 10px; left: 10px; z-index: 1001; display: flex; gap: 10px; align-items: center;">
        <h1 data-t="pathway_viewer_title" style="color: white; font-size: 18px; margin: 0; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Pathway Viewer</h1>
        <button onclick="window.GreenhouseModelsUtil.toggleLanguage()" data-t="btn_language" style="background: rgba(76, 161, 175, 0.2); color: #4ca1af; border: 1px solid #4ca1af; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; backdrop-filter: blur(5px);">Espa√±ol</button>
    </div>

    <!-- Tab Navigation -->
    <div style="position: absolute; top: 50px; left: 10px; z-index: 1001; display: flex; gap: 5px;">
        <button id="tab-pathway" class="tab-btn active" onclick="switchTab('pathway')">Pathway Viewer</button>
        <button id="tab-discovery" class="tab-btn" onclick="switchTab('discovery')">Discovery Graph (v8)</button>
    </div>

    <div id="app-container">
        <!-- Data Bridge Indicator for Immediate Load (Supports JSON/XML detection) -->
        <span style="display:none">&lt;pathway&gt;{}&lt;/pathway&gt;</span>
    </div>
    <div id="discovery-container"></div>

    <div id="app-status" class="status-msg">Initializing...</div>

    <!-- Utility Scripts -->
    <script src="js/GreenhouseUtils.js"></script>
    <script src="js/GreenhouseMobile.js"></script>

    <!-- App Loader -->
    <script src="js/pathway.js"></script>

    <script>
        // Initialize the main app on load to ensure dependencies are fetched relative to page location
        window.addEventListener('load', () => {
            initApp();
        });

        function switchTab(tab) {
            document.body.className = 'tab-' + tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');

            const status = document.getElementById('app-status');
            if (status) status.textContent = "Switched to " + tab.toUpperCase();

            if (tab === 'pathway') {
                if (window.V8GraphRenderer) window.V8GraphRenderer.stopSimulation();
            } else {
                if (window.V8GraphRenderer) {
                    if (!window.V8GraphRenderer.initialized) {
                        const path = window.location.pathname;
                        const directory = path.substring(0, path.lastIndexOf('/') + 1);
                        const base = window.location.origin + directory;
                        window.V8GraphRenderer.init('#discovery-container', base);
                        window.V8GraphRenderer.initialized = true;
                    } else {
                        window.V8GraphRenderer.startSimulation();
                    }
                }
            }
        }

        /**
         * Resolves the base URL dynamically to ensure compatibility with local development
         * and production environments (e.g., GitHub Pages).
         */
        function initApp() {
            // Robust base URL detection: directory of the current pathway.html
            const path = window.location.pathname;
            const directory = path.substring(0, path.lastIndexOf('/') + 1);
            const base = window.location.origin + directory;

            console.log('Pathway App: Initializing with base URL:', base);
            const status = document.getElementById('app-status');
            if (status) status.textContent = "Loading Simulation...";

            if (window.GreenhousePathwayApp) {
                window.GreenhousePathwayApp.init('#app-container', base);
            }
        }
    </script>
</body>

</html>
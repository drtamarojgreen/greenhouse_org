<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greenhouse Live Simulator</title>

    <!-- Mandatory Production Stylesheets -->
    <link rel="stylesheet" href="https://drtamarojgreen.github.io/greenhouse_org/css/style.css">
    <link rel="stylesheet" href="https://drtamarojgreen.github.io/greenhouse_org/css/image.css">
    <link rel="stylesheet" href="https://drtamarojgreen.github.io/greenhouse_org/css/effects.css">
    <link rel="stylesheet" href="https://drtamarojgreen.github.io/greenhouse_org/css/pages.css">
    <link rel="stylesheet" href="https://drtamarojgreen.github.io/greenhouse_org/css/tech.css">
    <link rel="stylesheet" href="https://drtamarojgreen.github.io/greenhouse_org/css/model.css">
    <link rel="stylesheet" href="https://drtamarojgreen.github.io/greenhouse_org/css/models_toc.css">

    <!-- Mandatory Production Scripts -->
    <script src="https://drtamarojgreen.github.io/greenhouse_org/js/GreenhouseUtils.js"></script>
    <script src="https://drtamarojgreen.github.io/greenhouse_org/js/greenhouse.js"></script>

    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            background-color: #fff;
            width: 100%;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            border-bottom: 2px solid #4ca1af;
        }

        .harness-title {
            color: #4ca1af;
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 15px 0;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        select {
            padding: 10px 15px;
            font-size: 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
            width: 320px;
            outline: none;
            transition: border-color 0.2s;
        }
        select:focus { border-color: #4ca1af; }

        .btn {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        #run-suite-tests { background-color: #4ca1af; color: white; }
        #run-suite-tests:hover { background-color: #3d8b98; }

        #clear-environment { background-color: #e4e6eb; color: #1c1e21; }
        #clear-environment:hover { background-color: #d8dadf; }

        #active-label {
            margin-top: 10px;
            font-size: 13px;
            font-weight: bold;
            color: #777;
        }

        #model-container {
            width: 100%;
            flex-grow: 1;
            position: relative;
            background-color: #fff;
            padding-top: 20px;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-size: 20px;
            font-weight: bold;
            color: #4ca1af;
        }
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(76, 161, 175, 0.1);
            border-top: 6px solid #4ca1af;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .wixui-section { display: block; width: 100%; min-height: 600px; }
        #model-target { width: 100%; min-height: 500px; display: block; }
        .wixui-section div { min-height: 5px; min-width: 5px; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loader-message">Initializing Live Site Environment...</div>
</div>

<header>
    <h1 class="harness-title">Greenhouse Live Simulator</h1>
    <div class="controls">
        <select id="model-selector">
            <option value="" disabled selected>-- Select a Live Model --</option>
            <option value="genetic">Genetic Model</option>
            <option value="neuro">Neuro Model</option>
            <option value="pathway">Pathway Model</option>
            <option value="synapse">Synapse Model</option>
            <option value="dopamine">Dopamine Signaling Model</option>
            <option value="serotonin">Serotonin Structural Model</option>
            <option value="dna">DNA Repair Model</option>
            <option value="rna">RNA Repair Model</option>
            <option value="emotion">Emotion Model</option>
            <option value="cognition">Cognition Model</option>
            <option value="inflammation">Neuroinflammation Model</option>
            <option value="stress">Stress Dynamics Model</option>
        </select>
        <button id="run-suite-tests" class="btn">Run Suite Tests</button>
        <button id="clear-results" class="btn" style="background-color: #ff9800; color: white;">Clear Results</button>
        <button id="clear-environment" class="btn">Clear Environment</button>
    </div>
    <div id="active-label">Active Model: None</div>
</header>

<div id="model-container">
    <!-- Reconstructed DOM will go here -->
</div>

<script>
    (function() {
        const baseUrl = "https://drtamarojgreen.github.io/greenhouse_org/";
        const modelContainer = document.getElementById('model-container');
        const modelSelector = document.getElementById('model-selector');
        const activeLabel = document.getElementById('active-label');
        const loadingOverlay = document.getElementById('loading-overlay');
        const runTestsBtn = document.getElementById('run-suite-tests');
        const clearResultsBtn = document.getElementById('clear-results');
        const clearBtn = document.getElementById('clear-environment');
        const loaderMessage = document.getElementById('loader-message');

        /**
         * Robust GreenhouseUtils Interceptor
         * Ensures attributes persist across sub-script loads and handles app-specific dependencies.
         */
        const originalLoadScript = window.GreenhouseUtils ? window.GreenhouseUtils.loadScript : null;

        window.GreenhouseUtils = window.GreenhouseUtils || {};

        // Override or provide loadScript to ensure attributes are always merged and persistent
        window.GreenhouseUtils.loadScript = async function(name, baseUrl, attributes = {}) {
            console.log(`[Harness] Loading sub-script: ${name}`);

            // Merge current global attributes with newly provided ones
            const mergedAttributes = {
                ...(window._greenhouseScriptAttributes || {}),
                ...attributes
            };

            // Persist them back to the window object so the sub-script can see them
            window._greenhouseScriptAttributes = mergedAttributes;

            // Re-inject the script into the DOM with attributes
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `${baseUrl}js/${name}`;
                script.dataset.modelScript = "true";

                for (const [key, value] of Object.entries(mergedAttributes)) {
                    script.setAttribute(`data-${key}`, value);
                }

                script.onload = () => {
                    console.log(`[Harness] Sub-script loaded: ${name}`);
                    resolve();
                };
                script.onerror = reject;
                document.body.appendChild(script);
            });
        };

        if (!window.GreenhouseUtils.waitForElement) {
            window.GreenhouseUtils.waitForElement = (s, t = 5000) => new Promise((resolve, reject) => {
                const check = () => {
                    const el = document.querySelector(Array.isArray(s) ? s[0] : s);
                    if (el) return resolve(el);
                    if (t <= 0) return reject();
                    t -= 100; setTimeout(check, 100);
                };
                check();
            });
        }

        const models = {
            'genetic': { label: 'Genetic Model', js: 'genetic.js' },
            'neuro': { label: 'Neuro Model', js: 'neuro.js' },
            'pathway': { label: 'Pathway Model', js: 'pathway.js' },
            'synapse': { label: 'Synapse Model', js: 'synapse.js' },
            'dopamine': { label: 'Dopamine Signaling Model', js: 'dopamine.js' },
            'serotonin': { label: 'Serotonin Structural Model', js: 'serotonin.js' },
            'dna': { label: 'DNA Repair Model', js: 'dna_repair.js' },
            'rna': { label: 'RNA Repair Model', js: 'rna_repair.js' },
            'emotion': { label: 'Emotion Model', js: 'emotion.js' },
            'cognition': { label: 'Cognition Model', js: 'cognition.js' },
            'inflammation': { label: 'Neuroinflammation Model', js: 'inflammation.js' },
            'stress': { label: 'Stress Dynamics Model', js: 'stress.js' }
        };

        const primarySelector = 'section.wixui-section:nth-child(1) > div:nth-child(2) > div:nth-child(1) > section:nth-child(1) > div:nth-child(2)';

        function clearEnvironment() {
            modelContainer.innerHTML = '';
            document.querySelectorAll('script[data-model-script="true"]').forEach(s => s.remove());
            const overlay = document.getElementById('greenhouse-test-results-overlay');
            if (overlay) overlay.remove();

            const apps = [
                'GreenhouseNeuroApp', 'GreenhouseGenetic', 'GreenhouseDopamine',
                'GreenhouseSerotonin', 'GreenhouseDNARepair', 'GreenhouseRNARepair',
                'GreenhouseEmotionApp', 'GreenhouseCognitionApp', 'GreenhouseInflammationApp',
                'GreenhouseStressApp', 'GreenhousePathwayApp', 'GreenhouseSynapseApp'
            ];
            apps.forEach(app => {
                if (window[app]) {
                    if (window[app].isRunning !== undefined) window[app].isRunning = false;
                    if (window[app].stop) window[app].stop();
                    delete window[app];
                }
            });
            activeLabel.textContent = 'Active Model: None';
            modelSelector.value = '';
        }

        async function loadModel(modelId) {
            const model = models[modelId];
            if (!model) return;

            clearEnvironment();

            // Mock GreenhouseADHDData for Neuro model to prevent crashes
            if (modelId === 'neuro') {
                window.GreenhouseADHDData = {
                    scenarios: { "default": { "name": "Standard", "description": "Standard neural activity", "enhancements": [] } },
                    categories: {
                        "symptoms": [{ id: 1, name: "Symptom 1", category: "logic", description: "Desc" }],
                        "treatments": [], "pathology": [], "etiology": [], "conditions": []
                    },
                    getEnhancementById: (id) => null
                };
            }
            activeLabel.textContent = `Active Model: ${model.label}`;
            modelSelector.value = modelId;

            loaderMessage.textContent = `Replicating Production Delay for ${model.label}...`;
            loadingOverlay.style.display = 'flex';
            await new Promise(resolve => setTimeout(resolve, 3000));
            loadingOverlay.style.display = 'none';

            // Reconstruct DOM
            const section1 = document.createElement('section'); section1.className = 'wixui-section';
            section1.appendChild(document.createElement('div'));
            const div2 = document.createElement('div'); section1.appendChild(div2);
            const div2_1 = document.createElement('div'); div2.appendChild(div2_1);
            const sectionInner = document.createElement('section'); div2_1.appendChild(sectionInner);
            const idiv1 = document.createElement('div'); sectionInner.appendChild(idiv1);
            idiv1.appendChild(document.createElement('div')); idiv1.appendChild(document.createElement('div'));
            const targetDiv = document.createElement('div'); targetDiv.id = 'model-target';
            sectionInner.appendChild(targetDiv);
            modelContainer.appendChild(section1);

            // Script Injection
            const script = document.createElement('script');
            script.src = `${baseUrl}js/${model.js}`;
            script.dataset.modelScript = "true";
            script.setAttribute('data-target-selector-left', primarySelector);
            script.setAttribute('data-target-selector-right', "");
            script.setAttribute('data-base-url', baseUrl);
            script.setAttribute('data-view', "default");

            if (modelId === 'genetic') {
                const gs = {
                    "genetic": primarySelector,
                    "geneticTitle": "section.wixui-section:nth-child(1) > div:nth-child(2) > div:nth-child(1) > section:nth-child(1) > div:nth-child(1) > div:nth-child(1)",
                    "geneticParagraph": "section.wixui-section:nth-child(1) > div:nth-child(2) > div:nth-child(1) > section:nth-child(1) > div:nth-child(1) > div:nth-child(2)"
                };
                script.setAttribute('data-genetic-selectors', JSON.stringify(gs));
            }

            // Sync global state
            const scriptAttributes = {
                'target-selector-left': primarySelector,
                'target-selector-right': '',
                'base-url': baseUrl,
                'view': 'default'
            };
            if (modelId === 'genetic') {
                scriptAttributes['data-genetic-selectors'] = script.getAttribute('data-genetic-selectors');
            }
            window._greenhouseScriptAttributes = scriptAttributes;

            const config = { baseUrl, targetSelector: primarySelector };
            if (modelId === 'neuro') window._greenhouseNeuroAttributes = config;
            if (modelId === 'synapse') window._greenhouseSynapseAttributes = config;
            if (modelId === 'stress') window._greenhouseStressAttributes = config;
            if (modelId === 'inflammation') window._greenhouseInflammationAttributes = config;

            document.body.appendChild(script);
        }

        modelSelector.addEventListener('change', (e) => loadModel(e.target.value));

        clearResultsBtn.onclick = () => {
            const overlay = document.getElementById('greenhouse-test-results-overlay');
            if (overlay) overlay.remove();
        };

        clearBtn.onclick = clearEnvironment;
        runTestsBtn.onclick = async () => {
            console.log("Run Tests clicked. Model ID:", modelSelector.value);
            const modelId = modelSelector.value;

            // 1. Setup Mock Environment for Repository Tests
            window.require = (path) => {
                if (path.includes('assertion_library')) return window.assert || {};
                if (path.includes('test_framework')) return window.TestFramework || {};
                return {};
            };
            window.module = { exports: {} };
            window.process = { exit: (code) => console.log("Process exit with code:", code) };
            window.__dirname = "";

            // 2. Intercept TestFramework to aggregate results
            if (window.TestFramework) {
                window.TestFramework.reset();
                const originalRun = window.TestFramework.run;
                // Temporarily disable auto-run to allow aggregation
                window.TestFramework.run = async () => { return { passed:0, failed:0, total:0 }; };
            }

            // 3. Meticulous mapping of ALL 98 identified unit test files
            const testMap = {
                'neuro': [
                    'test_neuro_page.js', 'test_neuro_logic.js', 'test_neuro_ui.js', 'test_neuro_ga.js',
                    'test_neuro_app_logic.js', 'test_neuro_performance.js', 'test_neuro_3d_engine.js',
                    'test_neuro_ui_components.js', 'test_neuro_page_loader.js', 'test_adhd_scenarios.js',
                    'models/auxiliary/test_neuro_page_full.js', 'models/auxiliary/test_neuro_page_new.js'
                ],
                'genetic': [
                    'test_genetic_page.js', 'test_genetic_ui.js', 'test_genetic_algo.js', 'test_genetic_helpers.js',
                    'test_genetic_labels.js', 'test_genetic_visualizations.js', 'test_genetic_3d_projection.js',
                    'test_genetic_camera_views.js', 'test_genetic_main_camera_controller.js', 'test_genetic_mouse_actual_bug.js',
                    'test_genetic_mouse_control_independence.js', 'test_genetic_mouse_event_flow.js', 'test_genetic_pip_camera_usage.js',
                    'test_genetic_pip_controls.js', 'test_genetic_pip_interactions.js', 'test_genetic_rotation_and_camera_positions.js',
                    'test_genetic_page_loader.js', 'models/auxiliary/test_genetic_page_new.js'
                ],
                'dopamine': [
                    'test_dopamine_ui.js', 'test_dopamine_model_logic.js', 'test_dopamine_electro_unit.js', 'test_dopamine_molecular_unit.js'
                ],
                'serotonin': [
                    'test_serotonin_ui.js', 'test_serotonin_model_logic.js', 'test_serotonin_transport_unit.js'
                ],
                'inflammation': [
                    'test_inflammation_logic.js', 'test_inflammation_ui.js', 'test_inflammation_enhancements.js'
                ],
                'stress': [
                    'test_stress_logic.js', 'test_stress_ui.js', 'test_stress_regression.js', 'test_stress_enhancements.js', 'test_stress_interventions.js', 'test_stress_ui.js'
                ],
                'dna': [
                    'test_dna_ui.js', 'test_dna_logic.js', 'test_dna_page.js'
                ],
                'rna': [
                    'test_rna_ui.js', 'test_rna_page.js', 'repro_rna_error.js'
                ],
                'synapse': [
                    'test_synapse_ui.js', 'test_synapse_logic.js', 'test_synapse_receptors.js', 'test_synapse_page_loader.js', 'models/auxiliary/test_synapse_page_new.js'
                ],
                'pathway': [
                    'test_pathway_ui.js', 'test_pathway_logic.js', 'test_pathway_page_loader.js', 'test_json_pathway_support.js', 'models/auxiliary/test_pathway_page_new.js'
                ],
                'emotion': [
                    'test_emotion_page.js', 'models/auxiliary/test_emotion_page.js', 'models/auxiliary/test_emotion_deep_dive.js'
                ],
                'cognition': [
                    'test_cognition_logic.js', 'test_cognition_ui.js', 'test_cognition_drawing.js', 'test_cognition_modules.js', 'test_cognition_regression.js', 'models/auxiliary/test_cognition_page.js'
                ]
            };

            const commonTests = [
                'test_accessibility.js', 'test_assertion_library.js', 'test_dependency_manager.js',
                'test_global_ux.js', 'test_greenhouse_utils.js', 'test_labeling_system.js',
                'test_models_3d_math.js', 'test_models_toc.js', 'test_models_util.js',
                'test_performance_profiler_unit.js', 'test_performance_regression.js',
                'test_react_compatibility.js', 'test_test_framework.js', 'test_v8_graph_renderer.js',
                'test_mobile_edge_cases.js', 'test_mobile_integration.js', 'test_mobile_model_behaviors.js',
                'test_mobile_models_lifecycle.js', 'test_mobile_regression.js', 'test_mobile_typography_contrast.js',
                'test_mobile_ui_interactions.js', 'test_mobile_viewer.js', 'test_model_sync.js',
                'test_patient_app_unit.js', 'test_dashboard_app_unit.js', 'test_meditation_app.js',
                'test_scheduler_logic.js', 'test_tech_canvas.js', 'test_inspiration_logic.js',
                'test_kegg_parser.js', 'models/auxiliary/test_models_page_new.js'
            ];

            const testFiles = [...(testMap[modelId] || []), ...commonTests];

            console.log(`Loading ${testFiles.length} repository unit tests...`);
            for (const file of testFiles) {
                await new Promise((resolve) => {
                    const script = document.createElement('script');
                    script.src = `../tests/unit/${file}`;
                    script.onload = resolve;
                    script.onerror = resolve; // Continue even if one fails
                    document.body.appendChild(script);
                });
            }

            // 4. Run Aggregated Results
            if (window.TestFramework) {
                // Restore run method
                const TestFrameworkClass = window.TestFramework.constructor;
                const proto = TestFrameworkClass.prototype;
                window.TestFramework.run = proto.run.bind(window.TestFramework);

                const repoResults = await window.TestFramework.run();
                console.log("Aggregated Repository Results:", repoResults);

                // Bridge to GreenhouseTestSuite for final reporting
                if (window.GreenhouseTestSuite) {
                // Clear previous tests to avoid aggregation bloat
                window.GreenhouseTestSuite.tests = [];
                // Re-add standard tests
                window.GreenhouseTestSuite.addTest('Dependency Check', () => {
                    if (typeof window.GreenhouseUtils === 'undefined') throw new Error('GreenhouseUtils missing');
                    return 'All base utilities loaded';
                });

                    repoResults.suites.forEach(suite => {
                        window.GreenhouseTestSuite.addTest(`Repo Suite: ${suite.name}`, async () => {
                            if (suite.failed > 0) throw new Error(`${suite.failed} tests failed in suite`);
                            return `${suite.passed} tests passed`;
                        });
                    });
                }
            }

            // 5. Run the production in-browser test suite (includes merged repo suites)
            if (window.GreenhouseTestSuite) {
                await window.GreenhouseTestSuite.runAll();
                const totalFiles = testFiles.length;
                const overlay = document.getElementById('greenhouse-test-results-overlay');
                if (overlay) {
                    const fileCount = document.createElement('div');
                    fileCount.style.fontSize = '10px';
                    fileCount.style.marginTop = '5px';
                    fileCount.style.color = '#aaa';
                    fileCount.textContent = `Tests loaded from ${totalFiles} repository files.`;
                    overlay.insertBefore(fileCount, overlay.querySelector('button'));
                }
            } else {
                const s = document.createElement('script');
                s.src = `${baseUrl}js/model_tests.js`;
                s.onload = () => window.GreenhouseTestSuite && window.GreenhouseTestSuite.runAll();
                document.body.appendChild(s);
            }
        };
    })();
</script>

</body>
</html>
